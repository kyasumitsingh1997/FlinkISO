var TimeKnots={draw:function(t,e,i){var o={width:600,height:50,radius:10,lineWidth:4,color:"#999",background:"#FFF",dateFormat:"%Y/%m/%d %H:%M:%S",horizontalLayout:!0,showLabels:!1,labelFormat:"%Y/%m/%d %H:%M:%S",addNow:!1,seriesColor:d3.scale.category20(),dateDimension:!0};if(null!=i)for(var r in i)o[r]=i[r];0!=o.addNow&&e.push({date:new Date,name:o.addNowLabel||"Today"});var n=d3.select(t).append("div").style("opacity",0).style("position","absolute").style("font-family","Helvetica Neue").style("font-weight","600").style("background","rgba(0,0,0,1)").style("color","white").style("padding","5px 10px 5px 10px").style("-moz-border-radius","8px 8px").style("border-radius","8px 8px"),a=d3.select(t).append("svg").attr("width",o.width).attr("height",o.height);if(o.dateDimension)l=e.map(function(t){return Date.parse(t.date)}),s=d3.max(l),u=d3.min(l);else var l=e.map(function(t){return t.value}),s=d3.max(l),u=d3.min(l);var d=1.5*(d3.max(e.map(function(t){return t.radius}))||o.radius)+o.lineWidth,h=o.horizontalLayout?(o.width-2*d)/(s-u):(o.height-2*d)/(s-u),f=[];if(s==u&&(h=0,d=o.horizontalLayout?o.width/2:o.height/2),linePrevious={x1:null,x2:null,y1:null,y2:null},a.selectAll("line").data(e).enter().append("line").attr("class","timeline-line").attr("x1",function(t){var e;if(o.horizontalLayout){var i=o.dateDimension?new Date(t.date).getTime():t.value;e=Math.floor(h*(i-u)+d)}else e=Math.floor(o.width/2);return linePrevious.x1=e,e}).attr("x2",function(t){if(null!=linePrevious.x1)return linePrevious.x1;if(o.horizontalLayout){var e=o.dateDimension?new Date(t.date).getTime():t.value;ret=Math.floor(h*(e-u))}return Math.floor(o.width/2)}).attr("y1",function(t){var e;if(o.horizontalLayout)e=Math.floor(o.height/2);else{var i=o.dateDimension?new Date(t.date).getTime():t.value;e=Math.floor(h*(i-u))+d}return linePrevious.y1=e,e}).attr("y2",function(t){if(null!=linePrevious.y1)return linePrevious.y1;if(o.horizontalLayout)return Math.floor(o.height/2);var e=o.dateDimension?new Date(t.date).getTime():t.value;return Math.floor(h*(e-u))}).style("stroke",function(t){return null!=t.color?t.color:null!=t.series?(f.indexOf(t.series)<0&&f.push(t.series),o.seriesColor(f.indexOf(t.series))):o.color}).style("stroke-width",o.lineWidth),a.selectAll("circle").data(e).enter().append("circle").attr("class","timeline-event").attr("r",function(t){return null!=t.radius?t.radius:o.radius}).style("stroke",function(t){return null!=t.color?t.color:null!=t.series?(f.indexOf(t.series)<0&&f.push(t.series),console.log(t.series,f,f.indexOf(t.series)),o.seriesColor(f.indexOf(t.series))):o.color}).style("stroke-width",function(t){return null!=t.lineWidth?t.lineWidth:o.lineWidth}).style("fill",function(t){return null!=t.background?t.background:o.background}).attr("cy",function(t){if(o.horizontalLayout)return Math.floor(o.height/2);var e=o.dateDimension?new Date(t.date).getTime():t.value;return Math.floor(h*(e-u)+d)}).attr("cx",function(t){if(o.horizontalLayout){var e=o.dateDimension?new Date(t.date).getTime():t.value;return Math.floor(h*(e-u)+d)}return Math.floor(o.width/2)}).on("mouseover",function(t){if(o.dateDimension)var e=""!=(i=d3.time.format(o.dateFormat)(new Date(t.date)))?t.name+" <small>("+i+")</small>":t.name;else{var i=t.value;e=t.name+" <small>("+t.value+")</small>"}d3.select(this).style("fill",function(t){return null!=t.color?t.color:o.color}).transition().duration(100).attr("r",function(t){return null!=t.radius?Math.floor(1.5*t.radius):Math.floor(1.5*o.radius)}),n.html(""),null!=t.img&&n.append("img").style("float","left").style("margin-right","4px").attr("src",t.img).attr("width","64px"),n.append("div").style("float","left").html(e),n.transition().duration(100).style("opacity",.9)}).on("mouseout",function(){d3.select(this).style("fill",function(t){return null!=t.background?t.background:o.background}).transition().duration(100).attr("r",function(t){return null!=t.radius?t.radius:o.radius}),n.transition().duration(100).style("opacity",0)}),0!=o.showLabels){if(o.dateDimension)var c=(y=d3.time.format(o.labelFormat))(new Date(u)),m=y(new Date(s));else{var y=function(t){return t};c=u,m=s}a.append("text").text(c).style("font-size","70%").attr("x",function(t){return o.horizontalLayout?d3.max([0,d-this.getBBox().width/2]):Math.floor(this.getBBox().width/2)}).attr("y",function(t){return o.horizontalLayout?Math.floor(o.height/2+(d+this.getBBox().height)):d+this.getBBox().height/2}),a.append("text").text(m).style("font-size","70%").attr("x",function(t){return o.horizontalLayout?o.width-d3.max([this.getBBox().width,d+this.getBBox().width/2]):Math.floor(this.getBBox().width/2)}).attr("y",function(t){return o.horizontalLayout?Math.floor(o.height/2+(d+this.getBBox().height)):o.height-d+this.getBBox().height/2})}a.on("mousemove",function(){return tipPixels=parseInt(n.style("height").replace("px","")),n.style("top",tipPixels-50+"px").style("left",d3.event.pageX-145+"px")}).on("mouseout",function(){return n.style("opacity",0).style("top","0px").style("left","0px")})}};